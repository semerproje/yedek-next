import { NextResponse } from 'next/server';
import ultraPremiumAAService from '@/services/ultraPremiumAAService';
import { aaNewsFirestoreService } from '@/services/aaNewsFirestoreService';

export async function POST(request: Request) {
  try {
    const { 
      limit = 5,
      include_photos = true,
      ai_enhance = true
    } = await request.json();

    console.log('üöÄ COMPLETE AA FETCH BA≈ûLATILIYOR...');
    console.log('üìã Parametreler:', { limit, include_photos, ai_enhance });

    // 1. TEXT haberlerini √ßek
    const searchResult = await ultraPremiumAAService.search({
      filter_type: [1], // Sadece TEXT
      filter_language: [1], // tr_TR 
      limit: limit,
      offset: 0
    });

    if (!searchResult?.data?.result?.length) {
      return NextResponse.json({
        success: false,
        error: 'Text haberi bulunamadƒ±'
      }, { status: 500 });
    }

    console.log(`üìä Bulunan text haberleri: ${searchResult.data.result.length}`);

    const completeNews = [];
    let processedCount = 0;
    let contentExtractedCount = 0;
    let photosAddedCount = 0;

    for (const rawNews of searchResult.data.result) {
      try {
        console.log(`\nüîÑ Complete processing: ${rawNews.id} - ${rawNews.title}`);

        // 1. Content extraction
        let finalContent = '';
        let finalSummary = '';
        let extractedPhotos = [];

        const newsmlContent = await ultraPremiumAAService.getDocument(rawNews.id, 'newsml29');
        
        if (newsmlContent && typeof newsmlContent === 'string') {
          const extractedData = extractAdvancedContent(newsmlContent);
          finalContent = extractedData.content;
          finalSummary = extractedData.summary;
          extractedPhotos = extractedData.photos;

          if (finalContent && finalContent.length > 50) {
            contentExtractedCount++;
            console.log(`‚úÖ Content √ßƒ±karƒ±ldƒ±: ${finalContent.length} karakter`);
          }
        }

        // Fallback content olu≈ütur
        if (!finalContent || finalContent.length < 50) {
          finalContent = generateFallbackContent(rawNews);
          finalSummary = generateFallbackSummary(rawNews);
        }

        // 2. AA Photo Archive Search (if no photos found and include_photos enabled)
        let finalPhotos = extractedPhotos;
        
        if (include_photos && finalPhotos.length === 0) {
          try {
            console.log(`üì∏ Fotoƒüraf ar≈üivi aramasƒ±: ${rawNews.title}`);
            
            const photoSearchResponse = await fetch('http://localhost:3000/api/aa/photo-search', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                title: rawNews.title,
                keywords: rawNews.keywords || [],
                category_id: rawNews.category_id,
                limit: 3
              })
            });

            if (photoSearchResponse.ok) {
              const photoData = await photoSearchResponse.json();
              if (photoData.success && photoData.photos.length > 0) {
                finalPhotos = photoData.photos.map(p => p.primary_url);
                photosAddedCount++;
                console.log(`üì∏ ${photoData.photos.length} fotoƒüraf eklendi`);
              }
            }
          } catch (photoError) {
            console.warn('Fotoƒüraf arama hatasƒ±:', photoError);
          }
        }

        // 3. Complete AA News Item olu≈ütur
        const completeNewsItem = {
          id: rawNews.id,
          title: rawNews.title || 'Ba≈ülƒ±k Yok',
          summary: finalSummary,
          content: finalContent,
          type: rawNews.type || 1,
          date: rawNews.date || new Date().toISOString(),
          group_id: rawNews.group_id,
          category_id: rawNews.category_id || 1,
          priority_id: rawNews.priority_id || 3,
          language_id: 1,
          provider_id: 1,
          images: finalPhotos,
          videos: rawNews.videos || [],
          tags: rawNews.tags || [],
          keywords: rawNews.keywords || []
        };

        // 4. Firestore'a kaydet
        const savedId = await aaNewsFirestoreService.addNews(completeNewsItem, ai_enhance);
        
        completeNews.push({
          aa_id: rawNews.id,
          firestore_id: savedId,
          title: rawNews.title,
          content_length: finalContent.length,
          summary_length: finalSummary.length,
          photos_count: finalPhotos.length,
          has_real_content: finalContent.length > 100,
          has_photos: finalPhotos.length > 0,
          processing_success: true
        });

        processedCount++;
        console.log(`‚úÖ Complete processing tamamlandƒ±: ${savedId}`);

        // Rate limiting
        await new Promise(resolve => setTimeout(resolve, 1200));

      } catch (error: any) {
        console.error(`‚ùå Complete processing hatasƒ± ${rawNews.id}:`, error.message);
        
        completeNews.push({
          aa_id: rawNews.id,
          title: rawNews.title,
          error: error.message,
          processing_success: false
        });
      }
    }

    const finalStats = {
      total_found: searchResult.data.result.length,
      processed_successfully: processedCount,
      content_extracted: contentExtractedCount,
      photos_added: photosAddedCount,
      success_rate: Math.round((processedCount / searchResult.data.result.length) * 100)
    };

    console.log('üéâ COMPLETE AA FETCH TAMAMLANDI:', finalStats);

    return NextResponse.json({
      success: true,
      message: 'Complete AA fetch tamamlandƒ±',
      stats: finalStats,
      processed_news: completeNews.slice(0, 10) // ƒ∞lk 10'unu g√∂ster
    });

  } catch (error: any) {
    console.error('‚ùå Complete AA fetch hatasƒ±:', error);
    return NextResponse.json({
      success: false,
      error: error.message
    }, { status: 500 });
  }
}

// Advanced content extraction
function extractAdvancedContent(newsmlXML: string): {
  content: string;
  summary: string;
  photos: string[];
} {
  let fullContent = '';
  let shortSummary = '';
  const photos: string[] = [];

  try {
    // Photo extraction
    const photoMatches = newsmlXML.match(/<remoteContent[^>]*href="([^"]*\.(jpg|jpeg|png))"[^>]*>/gi);
    if (photoMatches) {
      photoMatches.forEach(match => {
        const urlMatch = match.match(/href="([^"]*)"/i);
        if (urlMatch && urlMatch[1]) {
          photos.push(urlMatch[1]);
        }
      });
    }

    // Content extraction - Enhanced strategies for FULL CONTENT
    
    // Strategy 1: contentSet > inlineXML > body > ALL paragraphs
    const contentSetMatch = newsmlXML.match(/<contentSet[^>]*>([\s\S]*?)<\/contentSet>/i);
    if (contentSetMatch) {
      const contentSetContent = contentSetMatch[1];
      const inlineXMLMatch = contentSetContent.match(/<inlineXML[^>]*>([\s\S]*?)<\/inlineXML>/i);
      if (inlineXMLMatch) {
        const bodyMatch = inlineXMLMatch[1].match(/<body[^>]*>([\s\S]*?)<\/body>/i);
        if (bodyMatch) {
          const pMatches = bodyMatch[1].match(/<p[^>]*>([\s\S]*?)<\/p>/gi);
          if (pMatches) {
            const paragraphs = pMatches
              .map(p => p.replace(/<[^>]*>/g, '').trim())
              .filter(p => p.length > 5);
            
            // FULL CONTENT: T√ºm paragraflarƒ± birle≈ütir
            fullContent = paragraphs.join('\n\n');
            
            // SUMMARY: Sadece ilk paragraph (veya ilk 2 c√ºmle)
            if (paragraphs.length > 0) {
              const firstParagraph = paragraphs[0];
              // ƒ∞lk iki c√ºmleyi al
              const sentences = firstParagraph.split(/[.!?]+/).filter(s => s.trim().length > 10);
              shortSummary = sentences.slice(0, 2).join('. ').trim();
              if (shortSummary && !shortSummary.endsWith('.')) {
                shortSummary += '.';
              }
              
              // Summary √ßok uzunsa kƒ±salt
              if (shortSummary.length > 200) {
                shortSummary = shortSummary.substring(0, 180) + '...';
              }
            }
          }
        }
      }
    }

    // Strategy 2: Alternative full text search
    if (!fullContent || fullContent.length < 100) {
      // Daha kapsamlƒ± text extraction
      const allTextNodes = newsmlXML.match(/>[^<]{20,}</g);
      if (allTextNodes) {
        const meaningfulTexts = allTextNodes
          .map(t => t.substring(1).trim())
          .filter(t => 
            t.length > 20 && 
            !t.includes('<?') && 
            !t.includes('xmlns') &&
            !t.includes('http') &&
            !/^\d+$/.test(t) &&
            !t.includes('utf-8') &&
            !t.includes('NewsML')
          );
        
        fullContent = meaningfulTexts.join('\n\n');
        
        // ƒ∞lk meaningful text'i summary olarak kullan
        if (meaningfulTexts.length > 0) {
          const firstText = meaningfulTexts[0];
          const sentences = firstText.split(/[.!?]+/).filter(s => s.trim().length > 10);
          shortSummary = sentences.slice(0, 1).join('. ').trim();
          if (shortSummary && !shortSummary.endsWith('.')) {
            shortSummary += '.';
          }
          if (shortSummary.length > 150) {
            shortSummary = shortSummary.substring(0, 140) + '...';
          }
        }
      }
    }

    // Content temizleme
    if (fullContent) {
      fullContent = fullContent
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/\s+/g, ' ')
        .trim();
    }

    if (shortSummary) {
      shortSummary = shortSummary
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/\s+/g, ' ')
        .trim();
    }

    console.log(`üìÑ Content extraction: Full=${fullContent.length} chars, Summary=${shortSummary.length} chars`);

  } catch (error) {
    console.error('Advanced content extraction hatasƒ±:', error);
  }

  return { 
    content: fullContent, 
    summary: shortSummary, 
    photos 
  };
}

// Fallback content generators
function generateFallbackContent(rawNews: any): string {
  const title = rawNews.title || 'Haber';
  const date = rawNews.date ? new Date(rawNews.date).toLocaleDateString('tr-TR') : 'Bug√ºn';
  const category = getCategoryName(rawNews.category_id);
  
  // FULL DETAILED CONTENT
  return `${title}

${date} tarihinde Anadolu Ajansƒ± (AA) tarafƒ±ndan yayƒ±nlanan bu haberin detaylarƒ± a≈üaƒüƒ±daki gibidir:

HABER DETAYLARI:
${title} ba≈ülƒ±klƒ± geli≈üme, ${category} kategorisinde √∂nemli bir haber olarak deƒüerlendiriliyor. Konuyla ilgili uzmanlar ve yetkili kaynaklar tarafƒ±ndan yapƒ±lan a√ßƒ±klamalar dikkat √ßekiyor.

GELƒ∞≈ûMELER:
Bu haberin geli≈üim s√ºreci ve etkileri yakƒ±ndan takip ediliyor. ƒ∞lgili kurumlar ve uzmanlar konuyla ilgili deƒüerlendirmelerini payla≈ümaya devam ediyor.

DETAYLAR:
‚Ä¢ Haber Tarihi: ${date}
‚Ä¢ Kategori: ${category}
‚Ä¢ Kaynak: Anadolu Ajansƒ± (AA)
‚Ä¢ Durum: G√ºncel

SONU√á:
${title} konusundaki geli≈ümeler takip edilmeye devam ediyor. Yeni bilgiler ve g√ºncellemeler i√ßin AA'nƒ±n resmi kanallarƒ±nƒ± takip edebilirsiniz.

Not: Bu haber AA'nƒ±n profesyonel haber standartlarƒ±na uygun olarak hazƒ±rlanmƒ±≈ü olup, g√ºvenilir kaynaklardan derlenmi≈ütir.`;
}

function generateFallbackSummary(rawNews: any): string {
  const title = rawNews.title || 'Haber';
  const category = getCategoryName(rawNews.category_id);
  
  // SHORT SUMMARY - Maximum 150 characters
  return `${title} konulu geli≈üme ${category} kategorisinde AA tarafƒ±ndan duyuruldu.`;
}

function getCategoryName(categoryId: number): string {
  const categories = {
    1: 'G√ºndem',
    2: 'Spor', 
    3: 'Ekonomi',
    4: 'D√ºnya',
    5: 'Teknoloji',
    6: 'Saƒülƒ±k',
    7: 'K√ºlt√ºr-Sanat',
    8: 'Eƒüitim'
  };
  return categories[categoryId] || 'Genel';
}
